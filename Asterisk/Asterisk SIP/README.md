# Zabbix-Asterisk-Templates
Шаблоны и скрипты мониторинга Asterisk по sip-транкам для Zabbix 4.4.

*Основа шаблона, скрипта, конфига и вдохновения взята с [serveradmin.ru](https://serveradmin.ru/monitoring-asterisk-v-zabbix). Исправил ошибки и переделал под собственные нужды - сам.*

**Список шаблонов:**
1. *Template_Asterisk_sip.xml* - основной шаблон для мониторинга по iax2.


**Информация о выводах в шаблонах**
1. Состояние транков. Если один из них отваливается, я узнаю о его имени уже в оповещении на почте.
2. Состояние самой службы asterisk на сервере. Тут все просто — либо работает, либо нет.
3. Состояние работы программы fail2ban. Тоже все просто — либо работает, либо нет.
4. Наличие цепочек fail2ban в таблице iptables. Эта проверка гарантирует, что fail2ban не только запущен, но и успешно блокирует нарушителей.
5. Факт перезапуска сервиса asterisk. Как бонус к этой метрике — uptime службы астериска.
6. Количество активных разговоров в данный момент.

**Установка и настройка**
1. Устанавливаем пакеты - "Язык шаблонного сканирования и обработки awk" и "Предоставление частичных привилегий суперпользователя другим пользователям":<br>
`# apt-get install gawk sudo`<br>
1.1. Добавляем в /etc/sudoers: `zabbix ALL = NOPASSWD: /usr/sbin/asterisk`

2. На машине с asterisk и настроенным zabbix-agent сохраняем скрипт *asterisk.trunk-with-name.sh* в папку **/etc/zabbix/scripts** (если папки нет - создаём). Даём скрипту права на запуск.

3. Сохраняем конфиг *asterisk.conf* в папку **/etc/zabbix/zabbix_agent.d/**.<br>
3.1. Если fail2ban в системе не используется, то строчки 2 и 4 можно закомментить, а на сервере отключить соответствующие элементы шаблона у хоста.<br>
3.2. "Скажу честно, мне было лениво разбираться с разрешениями и я просто запустил zabbix с правами root. Для этого в его конфиге /etc/zabbix/zabbix_agentd.conf раскомментировал следующую строку: 
`AllowRoot=1`"

4. Перезапускаем агента<br>
`# systemctl restart zabbix-agent`

5. Импортируем шаблон *Template_Asterisk_sip.xml* в zabbix-server, создаём хост и привязываемся к шаблону.

**Возможные проблемы**

1. Если новый item не работает, получает статус not supported, а в описании причины ошибка:
`Unable to connect to remote asterisk (does /var/run/asterisk/asterisk.ctl exist?)` - см. [Issues #2](https://github.com/Krushon/Zabbix_templates/issues/2)
